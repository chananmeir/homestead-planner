{% extends "base.html" %}

{% block title %}Compost Tracker - Homestead Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h2><i class="bi bi-recycle"></i> Compost Tracker</h2>
                <p class="text-muted">Manage compost piles and maintain the perfect C:N ratio (25-35:1)</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Pile Button -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPileModal">
            <i class="bi bi-plus-circle"></i> Add Compost Pile
        </button>
    </div>
</div>

<!-- Compost Piles -->
<div class="row">
    {% for pile in piles %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">{{ pile.name }}</h5>
            </div>
            <div class="card-body">
                <p><strong>Location:</strong> {{ pile.location }}<br>
                <strong>Size:</strong> {{ pile.width }}' × {{ pile.length }}' × {{ pile.height }}'<br>
                <strong>Status:</strong> <span class="badge bg-info">{{ pile.status }}</span></p>

                <!-- C:N Ratio -->
                <div class="alert {% if pile.cn_ratio >= 25 and pile.cn_ratio <= 35 %}alert-success{% elif pile.cn_ratio >= 20 and pile.cn_ratio <= 40 %}alert-warning{% else %}alert-danger{% endif %}">
                    <h4 class="mb-0">C:N Ratio: {{ "%.1f"|format(pile.cn_ratio) }}:1</h4>
                    <small>
                        {% if pile.cn_ratio >= 25 and pile.cn_ratio <= 35 %}
                        ✓ Ideal ratio!
                        {% elif pile.cn_ratio < 20 %}
                        Too much nitrogen (may smell)
                        {% else %}
                        Too much carbon (slow decomposition)
                        {% endif %}
                    </small>
                </div>

                <!-- Moisture -->
                <div class="mb-3">
                    <label>Moisture Level:</label>
                    <select class="form-select" onchange="updatePile({{ pile.id }}, 'moisture', this.value)">
                        <option value="dry" {% if pile.moisture == 'dry' %}selected{% endif %}>Too Dry</option>
                        <option value="ideal" {% if pile.moisture == 'ideal' %}selected{% endif %}>Ideal</option>
                        <option value="wet" {% if pile.moisture == 'wet' %}selected{% endif %}>Too Wet</option>
                    </select>
                </div>

                <!-- Last Turned -->
                <p><strong>Last Turned:</strong>
                {% if pile.last_turned %}
                    {{ pile.last_turned.strftime('%b %d, %Y') }}
                {% else %}
                    Never
                {% endif %}
                <button class="btn btn-sm btn-outline-primary" onclick="turnPile({{ pile.id }})">
                    <i class="bi bi-arrow-repeat"></i> Turn Now
                </button>
                </p>

                <!-- Ingredients -->
                <h6>Ingredients ({{ pile.ingredients|length }})</h6>
                <button class="btn btn-sm btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addIngredientModal" onclick="currentPileId = {{ pile.id }}">
                    <i class="bi bi-plus"></i> Add Material
                </button>

                {% for ing in pile.ingredients %}
                <div class="d-flex justify-content-between mb-1">
                    <span>
                        <span class="badge {% if ing.type == 'green' %}bg-success{% else %}bg-warning{% endif %}">
                            {{ ing.type }}
                        </span>
                        {{ ing.name|replace('-', ' ')|title }}
                    </span>
                    <small>{{ ing.amount }} cu ft • C:N {{ ing.cn_ratio }}:1</small>
                </div>
                {% endfor %}

                <hr>
                <button class="btn btn-sm btn-danger" onclick="deletePile({{ pile.id }})">
                    <i class="bi bi-trash"></i> Delete Pile
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Pile Modal -->
<div class="modal fade" id="addPileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Compost Pile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Pile Name</label>
                    <input type="text" class="form-control" id="pileName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="pileLocation" required>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label class="form-label">Width (ft)</label>
                        <input type="number" class="form-control" id="pileWidth" value="3" required>
                    </div>
                    <div class="col-4">
                        <label class="form-label">Length (ft)</label>
                        <input type="number" class="form-control" id="pileLength" value="3" required>
                    </div>
                    <div class="col-4">
                        <label class="form-label">Height (ft)</label>
                        <input type="number" class="form-control" id="pileHeight" value="3" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addPile()">Add Pile</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Ingredient Modal -->
<div class="modal fade" id="addIngredientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Material</label>
                    <select class="form-select" id="materialSelect">
                        <optgroup label="Green (Nitrogen)">
                            <option value="grass-clippings">Grass Clippings</option>
                            <option value="food-scraps">Food Scraps</option>
                            <option value="coffee-grounds">Coffee Grounds</option>
                            <option value="fresh-manure">Fresh Manure</option>
                            <option value="hay-fresh">Fresh Hay</option>
                        </optgroup>
                        <optgroup label="Brown (Carbon)">
                            <option value="dried-leaves">Dried Leaves</option>
                            <option value="straw">Straw</option>
                            <option value="wood-chips">Wood Chips</option>
                            <option value="cardboard">Cardboard</option>
                            <option value="paper">Paper</option>
                            <option value="sawdust">Sawdust</option>
                        </optgroup>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount (cubic feet)</label>
                    <input type="number" class="form-control" id="materialAmount" min="0" step="0.5" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addIngredient()">Add Material</button>
            </div>
        </div>
    </div>
</div>

<!-- Composting Tips -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5><i class="bi bi-lightbulb"></i> Composting Best Practices</h5>
                <ul>
                    <li><strong>C:N Ratio:</strong> Aim for 25-35:1. Too much nitrogen causes odor, too much carbon slows decomposition.</li>
                    <li><strong>Moisture:</strong> Should feel like a wrung-out sponge.</li>
                    <li><strong>Aeration:</strong> Turn pile every 7-14 days to add oxygen.</li>
                    <li><strong>Temperature:</strong> Active piles heat to 130-160°F, killing weed seeds.</li>
                    <li><strong>Size:</strong> Minimum 3'×3'×3' for proper heat generation.</li>
                    <li><strong>Timeline:</strong> Hot compost: 3-4 months. Cold compost: 6-12 months.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPileId = null;

function addPile() {
    const data = {
        name: $('#pileName').val(),
        location: $('#pileLocation').val(),
        size: {
            width: parseFloat($('#pileWidth').val()),
            length: parseFloat($('#pileLength').val()),
            height: parseFloat($('#pileHeight').val())
        }
    };

    $.ajax({
        url: '/api/compost-piles',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            location.reload();
        }
    });
}

function deletePile(id) {
    if (confirm('Delete this pile?')) {
        $.ajax({
            url: '/api/compost-piles/' + id,
            method: 'DELETE',
            success: function() {
                location.reload();
            }
        });
    }
}

function turnPile(id) {
    $.ajax({
        url: '/api/compost-piles/' + id,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({lastTurned: true}),
        success: function() {
            location.reload();
        }
    });
}

function updatePile(id, field, value) {
    const data = {};
    data[field] = value;
    $.ajax({
        url: '/api/compost-piles/' + id,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data)
    });
}

function addIngredient() {
    const data = {
        material: $('#materialSelect').val(),
        amount: parseFloat($('#materialAmount').val())
    };

    $.ajax({
        url: '/api/compost-piles/' + currentPileId + '/ingredients',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            location.reload();
        }
    });
}
</script>
{% endblock %}
