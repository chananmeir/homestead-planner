{% extends "base.html" %}

{% block title %}Planting Calendar - Homestead Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h2><i class="bi bi-calendar-event"></i> Planting Calendar</h2>
                <p class="text-muted">Plan your seed starting and transplanting schedule based on frost dates.</p>
            </div>
        </div>
    </div>
</div>

<!-- Frost Dates -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5><i class="bi bi-thermometer-snow"></i> Last Spring Frost</h5>
                <input type="date" class="form-control" id="lastFrostDate" value="{{ last_frost_date }}">
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5><i class="bi bi-thermometer-sun"></i> First Fall Frost</h5>
                <input type="date" class="form-control" id="firstFrostDate" value="{{ first_frost_date }}">
            </div>
        </div>
    </div>
</div>

<!-- Add Event -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="bi bi-plus-circle"></i> Add Planting Event
        </button>
    </div>
</div>

<!-- Events List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Scheduled Plantings</h5>
            </div>
            <div class="card-body">
                {% if events|length == 0 %}
                <p class="text-muted">No events scheduled yet. Add your first planting!</p>
                {% else %}
                <div class="list-group">
                    {% for event in events %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>{{ event.plant_id }}</h6>
                                {% if event.seed_start_date %}
                                <small>ðŸŒ± Start Seeds: {{ event.seed_start_date.strftime('%b %d, %Y') }}</small><br>
                                {% endif %}
                                {% if event.transplant_date %}
                                <small>ðŸŒ¿ Transplant: {{ event.transplant_date.strftime('%b %d, %Y') }}</small><br>
                                {% endif %}
                                {% if event.direct_seed_date %}
                                <small>ðŸŒ± Direct Seed: {{ event.direct_seed_date.strftime('%b %d, %Y') }}</small><br>
                                {% endif %}
                                <small>ðŸŽ‰ Harvest: {{ event.expected_harvest_date.strftime('%b %d, %Y') }}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent({{ event.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Planting Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Plant</label>
                    <select class="form-select" id="plantSelect">
                        {% for plant in plants %}
                        <option value="{{ plant.id }}">{{ plant.name }} ({{ plant.daysToMaturity }} days)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Planting Method</label>
                    <select class="form-select" id="plantingMethod">
                        <option value="transplant">Start Indoors & Transplant</option>
                        <option value="direct">Direct Seed</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addEvent()">Add Event</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$('#lastFrostDate, #firstFrostDate').on('change', function() {
    $.ajax({
        url: '/api/frost-dates',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            lastFrostDate: $('#lastFrostDate').val(),
            firstFrostDate: $('#firstFrostDate').val()
        }),
        success: function() {
            alert('Frost dates updated!');
        }
    });
});

function addEvent() {
    const plantId = $('#plantSelect').val();
    const method = $('#plantingMethod').val();
    const lastFrost = new Date($('#lastFrostDate').val());

    // Simple calculation - in production, get from plant data
    const seedStart = new Date(lastFrost);
    seedStart.setDate(seedStart.getDate() - 42); // 6 weeks before

    const transplant = new Date(lastFrost);
    transplant.setDate(transplant.getDate() + 14); // 2 weeks after

    const harvest = new Date(transplant);
    harvest.setDate(harvest.getDate() + 60); // Approximate

    const data = {
        plantId: plantId,
        seedStartDate: method === 'transplant' ? seedStart.toISOString() : null,
        transplantDate: method === 'transplant' ? transplant.toISOString() : null,
        directSeedDate: method === 'direct' ? transplant.toISOString() : null,
        expectedHarvestDate: harvest.toISOString()
    };

    $.ajax({
        url: '/api/planting-events',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            location.reload();
        }
    });
}

function deleteEvent(id) {
    if (confirm('Delete this event?')) {
        $.ajax({
            url: '/api/planting-events/' + id,
            method: 'DELETE',
            success: function() {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
