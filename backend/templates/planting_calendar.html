{% extends "base.html" %}

{% block title %}Planting Calendar - Homestead Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h2><i class="bi bi-calendar-event"></i> Planting Calendar</h2>
                <p class="text-muted">Plan your seed starting and transplanting schedule based on frost dates.</p>
            </div>
        </div>
    </div>
</div>

<!-- Frost Dates -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5><i class="bi bi-thermometer-snow"></i> Last Spring Frost</h5>
                <input type="date" class="form-control" id="lastFrostDate" value="{{ last_frost_date }}">
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5><i class="bi bi-thermometer-sun"></i> First Fall Frost</h5>
                <input type="date" class="form-control" id="firstFrostDate" value="{{ first_frost_date }}">
            </div>
        </div>
    </div>
</div>

<!-- Add Event -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="bi bi-plus-circle"></i> Add Planting Event
        </button>
    </div>
</div>

<!-- Events List by Month -->
<div class="row">
    <div class="col-12">
        {% if events|length == 0 %}
        <div class="card">
            <div class="card-body">
                <p class="text-muted">No events scheduled yet. Add your first planting!</p>
            </div>
        </div>
        {% else %}
        {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
        {% set events_by_month = {} %}

        {# Group events by month based on their primary action date #}
        {% for event in events %}
            {% set primary_date = event.seed_start_date or event.direct_seed_date or event.transplant_date %}
            {% if primary_date %}
                {% set month_key = primary_date.strftime('%Y-%m') %}
                {% set month_name = primary_date.strftime('%B %Y') %}
                {% if month_key not in events_by_month %}
                    {% set _ = events_by_month.update({month_key: {'name': month_name, 'events': []}}) %}
                {% endif %}
                {% set _ = events_by_month[month_key]['events'].append(event) %}
            {% endif %}
        {% endfor %}

        {# Display events grouped by month #}
        {% for month_key in events_by_month.keys()|sort %}
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calendar3"></i> {{ events_by_month[month_key]['name'] }}</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for event in events_by_month[month_key]['events'] %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">
                                    <span class="badge bg-success">{{ event.plant_id }}</span>
                                    {% if event.variety %}
                                    <span class="badge bg-info">{{ event.variety }}</span>
                                    {% endif %}
                                </h6>
                                <div class="small">
                                    {% if event.seed_start_date %}
                                    <div class="mb-1">
                                        <i class="bi bi-seed"></i> <strong>Start Seeds:</strong> {{ event.seed_start_date.strftime('%b %d') }}
                                    </div>
                                    {% endif %}
                                    {% if event.transplant_date %}
                                    <div class="mb-1">
                                        <i class="bi bi-arrow-left-right"></i> <strong>Transplant:</strong> {{ event.transplant_date.strftime('%b %d') }}
                                    </div>
                                    {% endif %}
                                    {% if event.direct_seed_date %}
                                    <div class="mb-1">
                                        <i class="bi bi-droplet"></i> <strong>Direct Seed:</strong> {{ event.direct_seed_date.strftime('%b %d') }}
                                    </div>
                                    {% endif %}
                                    <div class="mb-1">
                                        <i class="bi bi-basket"></i> <strong>Harvest:</strong> {{ event.expected_harvest_date.strftime('%b %d') }}
                                    </div>
                                    {% if event.notes %}
                                    <div class="text-muted mt-2">
                                        <i class="bi bi-journal-text"></i> {{ event.notes }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="ms-3">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent({{ event.id }})" title="Delete event">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Planting Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Plant</label>
                    <select class="form-select" id="plantSelect">
                        {% for plant in plants %}
                        <option value="{{ plant.id }}">{{ plant.name }} ({{ plant.daysToMaturity }} days)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Variety (Optional)</label>
                    <input type="text" class="form-control" id="varietyInput" list="varietySuggestions" placeholder="Select or type a variety...">
                    <datalist id="varietySuggestions">
                        <!-- Varieties will be populated based on selected plant -->
                    </datalist>
                    <small class="form-text text-muted">Choose from suggestions or type your own</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Planting Method</label>
                    <select class="form-select" id="plantingMethod">
                        <option value="transplant">Start Indoors & Transplant</option>
                        <option value="direct">Direct Seed</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addEvent()">Add Event</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Plant varieties database
const plantVarieties = {{ plant_varieties|tojson }};

// Update variety suggestions when plant is selected
$('#plantSelect').on('change', function() {
    const plantId = $(this).val();
    const varieties = plantVarieties[plantId] || [];

    // Update datalist with varieties for this plant
    const datalist = $('#varietySuggestions');
    datalist.empty();

    varieties.forEach(variety => {
        datalist.append(`<option value="${variety}">`);
    });

    // Clear the variety input
    $('#varietyInput').val('');
});

$('#lastFrostDate, #firstFrostDate').on('change', function() {
    $.ajax({
        url: '/api/frost-dates',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            lastFrostDate: $('#lastFrostDate').val(),
            firstFrostDate: $('#firstFrostDate').val()
        }),
        success: function() {
            alert('Frost dates updated!');
        }
    });
});

function addEvent() {
    const plantId = $('#plantSelect').val();
    const variety = $('#varietyInput').val();
    const method = $('#plantingMethod').val();
    const lastFrost = new Date($('#lastFrostDate').val());

    // Simple calculation - in production, get from plant data
    const seedStart = new Date(lastFrost);
    seedStart.setDate(seedStart.getDate() - 42); // 6 weeks before

    const transplant = new Date(lastFrost);
    transplant.setDate(transplant.getDate() + 14); // 2 weeks after

    const harvest = new Date(transplant);
    harvest.setDate(harvest.getDate() + 60); // Approximate

    const data = {
        plantId: plantId,
        variety: variety,
        seedStartDate: method === 'transplant' ? seedStart.toISOString() : null,
        transplantDate: method === 'transplant' ? transplant.toISOString() : null,
        directSeedDate: method === 'direct' ? transplant.toISOString() : null,
        expectedHarvestDate: harvest.toISOString()
    };

    $.ajax({
        url: '/api/planting-events',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            location.reload();
        }
    });
}

function deleteEvent(id) {
    if (confirm('Delete this event?')) {
        $.ajax({
            url: '/api/planting-events/' + id,
            method: 'DELETE',
            success: function() {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
